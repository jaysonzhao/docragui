<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S3 æ–‡ä»¶ä¸Šä¼ å™¨</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>ğŸš€ S3 æ–‡ä»¶ä¸Šä¼ å™¨</h1>
        
        <div class="upload-section">
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="file-input-container">
                    <input type="file" id="fileInput" name="file" required>
                    <label for="fileInput" class="file-input-label">
                        <div class="file-icon">ğŸ“</div>
                        <span id="fileInputText">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</span>
                        <div class="file-info">
                            <small>æ”¯æŒæ ¼å¼: txt, pdf, png, jpg, jpeg, gif, csv, json, xml, doc, docx, xls, xlsx, ppt, pptx, zip, rar, mp4, mp3</small>
                            <small>æœ€å¤§æ–‡ä»¶å¤§å°: 16MB</small>
                        </div>
                    </label>
                </div>
                
                <button type="submit" id="uploadBtn" class="upload-btn">
                    <span id="uploadBtnText">ğŸ“¤ ä¸Šä¼ åˆ° S3</span>
                    <div id="loadingSpinner" class="spinner" style="display: none;"></div>
                </button>
            </form>
        </div>
        
        <div id="result" class="result-section" style="display: none;">
            <div id="resultContent"></div>
        </div>
        
        <div class="files-section">
            <div class="section-header">
                <h3>ğŸ“‹ æœ€è¿‘ä¸Šä¼ çš„æ–‡ä»¶</h3>
                <button id="refreshFilesBtn" class="refresh-btn">ğŸ”„ åˆ·æ–°</button>
            </div>
            <div id="filesList" class="files-list">
                <div class="loading">æ­£åœ¨åŠ è½½...</div>
            </div>
        </div>
    </div>

    <script>
        // æ–‡ä»¶æ‹–æ‹½åŠŸèƒ½
        const fileInputLabel = document.querySelector('.file-input-label');
        const fileInput = document.getElementById('fileInput');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileInputLabel.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            fileInputLabel.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            fileInputLabel.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight(e) {
            fileInputLabel.classList.add('drag-over');
        }
        
        function unhighlight(e) {
            fileInputLabel.classList.remove('drag-over');
        }
        
        fileInputLabel.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            fileInput.files = files;
            updateFileName();
        }
        
        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        fileInput.addEventListener('change', updateFileName);
        
        function updateFileName() {
            const fileName = fileInput.files[0] ? fileInput.files[0].name : 'ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„';
            document.getElementById('fileInputText').textContent = fileName;
        }
        
        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadBtnText = document.getElementById('uploadBtnText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const resultDiv = document.getElementById('result');
            const resultContent = document.getElementById('resultContent');
            
            if (!fileInput.files[0]) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            uploadBtn.disabled = true;
            uploadBtnText.style.display = 'none';
            loadingSpinner.style.display = 'inline-block';
            resultDiv.style.display = 'none';
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    resultContent.innerHTML = `
                        <div class="success">
                            <h3>âœ… ä¸Šä¼ æˆåŠŸ!</h3>
                            <div class="file-details">
                                <p><strong>åŸå§‹æ–‡ä»¶å:</strong> ${data.original_filename}</p>
                                <p><strong>S3æ–‡ä»¶å:</strong> ${data.filename}</p>
                                <p><strong>æ–‡ä»¶å¤§å°:</strong> ${formatFileSize(data.size)}</p>
                                <p><strong>ä¸Šä¼ æ—¶é—´:</strong> ${data.upload_time}</p>
                                <p><strong>æ–‡ä»¶URL:</strong></p>
                                <div class="url-container">
                                    <input type="text" value="${data.url}" readonly class="url-input" id="fileUrl">
                                    <button onclick="copyToClipboard('fileUrl')" class="copy-btn">ğŸ“‹ å¤åˆ¶</button>
                                </div>
                                <p><a href="${data.url}" target="_blank" class="view-link">ğŸ”— æŸ¥çœ‹æ–‡ä»¶</a></p>
                            </div>
                        </div>
                    `;
                    
                    // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                    loadFilesList();
                    
                    // æ¸…ç©ºè¡¨å•
                    fileInput.value = '';
                    updateFileName();
                } else {
                    resultContent.innerHTML = `
                        <div class="error">
                            <h3>âŒ ä¸Šä¼ å¤±è´¥</h3>
                            <p>${result.error}</p>
                        </div>
                    `;
                }
                
                resultDiv.style.display = 'block';
                
            } catch (error) {
                resultContent.innerHTML = `
                    <div class="error">
                        <h3>âŒ ç½‘ç»œé”™è¯¯</h3>
                        <p>${error.message}</p>
                    </div>
                `;
                resultDiv.style.display = 'block';
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                uploadBtn.disabled = false;
                uploadBtnText.style.display = 'inline';
                loadingSpinner.style.display = 'none';
            }
        });
        
        // åŠ è½½æ–‡ä»¶åˆ—è¡¨
        async function loadFilesList() {
            const filesList = document.getElementById('filesList');
            filesList.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½...</div>';
            
            try {
                const response = await fetch('/files');
                const result = await response.json();
                
                if (result.success && result.files.length > 0) {
                    filesList.innerHTML = result.files.map(file => `
                        <div class="file-item">
                            <div class="file-info">
                                <div class="file-name">${file.key}</div>
                                <div class="file-meta">
                                    <span>å¤§å°: ${formatFileSize(file.size)}</span>
                                    <span>æ—¶é—´: ${file.last_modified}</span>
                                </div>
                            </div>
                            <div class="file-actions">
                                <a href="${file.url}" target="_blank" class="action-btn view-btn">æŸ¥çœ‹</a>
                                <button onclick="copyToClipboard('url-${file.key}')" class="action-btn copy-btn">å¤åˆ¶é“¾æ¥</button>
                                <input type="hidden" id="url-${file.key}" value="${file.url}">
                            </div>
                        </div>
                    `).join('');
                } else {
                    filesList.innerHTML = '<div class="no-files">æš‚æ— æ–‡ä»¶</div>';
                }
            } catch (error) {
                filesList.innerHTML = '<div class="error">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
            }
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            element.select();
            document.execCommand('copy');
            
            // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
            const originalText = event.target.textContent;
            event.target.textContent = 'âœ… å·²å¤åˆ¶';
            setTimeout(() => {
                event.target.textContent = originalText;
            }, 2000);
        }
        
        // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
        document.getElementById('refreshFilesBtn').addEventListener('click', loadFilesList);
        
        // é¡µé¢åŠ è½½æ—¶è·å–æ–‡ä»¶åˆ—è¡¨
        document.addEventListener('DOMContentLoaded', loadFilesList);
    </script>
</body>
</html>
